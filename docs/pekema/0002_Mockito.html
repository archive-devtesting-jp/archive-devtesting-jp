<!DOCTYPE html
    PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
    "http://www.w3.org/TR/html4/loose.dtd">
<html lang="en">
<head>
  <meta http-equiv="Content-Language" content="en">
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta http-equiv="Content-Script-Type" content="text/javascript; charset=UTF-8">
  <meta http-equiv="Content-Style-Type" content="text/css">
  <meta name="generator" content="Hiki 1.0.0">
  <title>xUTP Magazine - MockitoでサクサクTest Double生活(下)</title>
  <link rel="stylesheet" type="text/css" href="../theme/hiki_base.css" media="all">
  <link rel="stylesheet" type="text/css" href="../theme/hiki/hiki.css" media="all">
    <style type="text/css"><!--
    div.adminmenu {
    display: block;
}

span.adminmenu {
    background-color: rgb(255,255,255);
    color: rgb(255,255,255);
    border-color: rgb(255,255,255);
    border-style: solid;
    border-width: 0 1px 1px 0;
    padding: 2px;
    white-space: nowrap;
}

span.adminmenu a {
    background-color: transparent;
    color: rgb(255,255,255);
    text-decoration: none;
}
/*
span.adminmenu a:visited {
    background-color: transparent;
    color: #FFFFFF;
    text-decoration: none;
}
*/

span.adminmenu a:hover {
    background-color: transparent;
    color: green;
    text-decoration: none;
}

body {
    background-position: top center;
    background-color: #FFFFFF;
    color: #000000;
    margin-left: 0.4em;
    margin-top: 0;
    padding-top: 0;
}
h1 {
    border-color: #000000;
    border-style: solid;
    border-width: 0 0 1px;
    font-size: large;
    margin-bottom: 0.4em;
    margin-top: 50px;
    padding-left: 0.2em;
    text-align: left;
}
h1.header a {
    color: #444444;
    text-decoration: none;
}

div.body a {
    background-color: transparent;
    color: #0000EE;
}
div.body a:visited {
    background-color: transparent;
    color: #000095;
}
div.body a:hover {
    background-color: transparent;
    color: #FF6835;
}

div.body h3 a {
    text-decoration: none;
}
div.body h4 a {
    text-decoration: none;
}

div.referer, div.refererlist, div.day div.form {
    border-color: #AA1111;
    border-style: solid;
    border-width: 1px;
    font-size: small;
    margin-bottom: 0.5em;
    margin-left: 3em;
    padding: 0.5em;
}
div.day div.field {
    display: inline;
    margin-right: 1em;
}
img.icon {
    border: medium none;
    float: right;
    margin-left: 0.5em;
}
img.amazon {
    border: medium none;
    float: right;
    margin-left: 0.5em;
}
img.right {
    border: medium none;
    float: right;
    margin-left: 0.5em;
}
img.ext {
    border: medium none;
}
div.comment {
    display: none;
    font-size: x-small;
}
div.trackbacks {
    display: inline;
    font-size: small;
}

div.main {
    background-position: 0 44px;
    background-repeat: no-repeat;
    margin-left: 150px;
    margin-right: 0.6em;
    margin-top: 0;
    padding: 0;
    max-width: 100%;
}
div.main hr {
    background-color: transparent;
    color: #888888;
    width: 96%;
}
div.main hr.sep {
    display: none;
    margin: 0;
}
div.main h2 {
    background-color: #FFFFFF;
    border-bottom: 2px solid green;
    border-left: 15px solid green;
    color: #000000;
    font-size: 150%;
    margin: 0.5em 0;
    padding: 0.2em;
    text-align: left;
}
div.main p img {
    float: left;
    margin: 0.2em 0.8em 0.8em 0.2em;
}
div.main p em img {
    float: none;
    margin: 0.2em 0.8em 0.8em 0.2em;
}
div.main p strong img {
    clear: both;
    float: none;
    margin: 0;
    padding: 0;
}
div.main dt img {
    float: left;
    margin: 0.6em;
}
div.main dd img {
    float: right;
    margin: 0.2em 0.8em 0.6em 0.6em;
}
div.main dl {
    clear: none;
}
div.main div.day, h2, h3, h4, h5, h6, h7, h8, h9, hr {
    clear: both;
}
div.main h2 a:link, div.main h2 a:visited {
    background-color: transparent;
    text-decoration: none;
}
div.main h2 span.title {
}
div.main div.day {
    font-size: 90%;
    margin-right: 0;
}
div.main div.section {
    margin-left: 1em;
}
div.main span.readmore {
    font-size: 80%;
}
div.main div.lm {
    font-size: 75%;
    margin-bottom: 1em;
    margin-right: 1em;
    margin-top: 0;
    text-align: right;
}
span.lm {
    border-color: #950000;
    border-style: dashed;
    border-width: 1px 0 0;
}
div.main h3 {
    border-color: #950000;
    border-style: solid;
    border-width: 0 0 1px;
    font-size: 110%;
}
div.main h4 {
    border-color: #950000;
    border-style: dashed;
    border-width: 0 0 1px;
    font-size: 100%;
    margin-left: 0.6em;
}
div.main h5, h6, h7, h8, h9 {
    font-size: 100%;
    margin: 0;
    padding: 0.4em 1em;
}
div.main p {
    line-height: 1.5;
    margin-bottom: 0.5em;
    margin-top: 0;
    padding-right: 2em;
}
div.main li {
    line-height: 1.5;
}
div.main ul, div.main dl {
    margin-left: 2em;
    margin-top: 0.2em;
    padding-left: 0;
}
div.main dt {
    font-weight: bold;
    margin-top: 0.5em;
}
div.main dd {
    line-height: 140%;
    margin-left: 2em;
}
div.main pre {
    border-color: #888888;
    border-style: solid;
    border-width: 1px;
    clear: both;
    margin-left: 2em;
    padding: 4px;
}
div.main blockquote {
    background-color: #F0F0F0;
    border-color: #888888;
    border-style: solid;
    border-width: 1px;
    clear: both;
    color: #333333;
    padding: 8px 8px 0;
}
div.main table {
    border-collapse: collapse;
    margin: 1em;
    text-align: center;
}
div.main td {
    border: thin solid #888888;
    padding: 2px 0.6em;
}
div.form {
    clear: right;
}
span.corres {
    font-size: 80%;
    font-weight: lighter;
}
div.main span.footnote a {
    font-size: x-small;
    text-decoration: none;
}
div.main p.footnote {
    font-size: small;
}
div.main p.footnote a {
    text-decoration: none;
}
div.sidebar {
    display: block;
    background-color: green;
    background-repeat: no-repeat;
    color: #FFEEEE;
    left: 0;
    padding-bottom: 5em;
    padding-top: 50px;
    position: absolute;
    top: 0;
    width: 150px;
}
div.sidebar h4 {
    font-size: small;
    margin-bottom: 0.2em;
    margin-left: 6px;
    margin-top: 1em;
    padding-right: 8px;
}
div.sidebar h5 {
    font-size: small;
    margin-bottom: 0.2em;
    margin-left: 6px;
    margin-top: 1em;
    padding-right: 8px;
}
div.sidebar div.menu {
    font-size: small;
    font-weight: bold;
    padding-left: 4px;
}
div.sidebar ul {
    margin-left: 0;
    margin-top: 0;
    padding-left: 10px;
    padding-right: 8px;
}
div.sidebar li {
    font-size: x-small;
    line-height: 100%;
    list-style-type: none;
    margin: 6px 0;
}
div.sidebar hr {
    background-color: transparent;
    color: #FFFFFF;
    margin-bottom: 1em;
    width: 80%;
}
div.sidebar p {
    font-size: x-small;
    margin: 0;
    padding: 0;
}
div.sidebar form {
    font-size: x-small;
    line-height: 110%;
    margin-left: 0.5em;
    margin-right: 4px;
    margin-top: 0;
    padding-right: 8px;
}
div.sidebar a {
    background-color: transparent;
    color: #FFFFFF;
    text-decoration: none;
}
div.sidebar a:visited {
    background-color: transparent;
    color: #FFFFFF;
    text-decoration: none;
}
div.sidebar a:hover {
    background-color: transparent;
    color: #FFFFFF;
    text-decoration: none;
}
div.sidebar img {
    border-style: none;
    margin-left: 8px;
}
div.sidebar img.rubynokai {
    border-style: none;
    margin-left: 8px;
}
div.sidebar img.rubima_logo {
    border-style: none;
    left: 0;
    margin-left: 0;
    position: absolute;
    top: 49px;
}
div.footer {
    clear: both;
    font-size: 90%;
    margin-bottom: 1em;
    margin-right: 1em;
    padding-top: 36px;
    text-align: right;
    text-decoration: none;
}

.LineNumber {
    color: #AAAAAA;
}
.html_linenumber {
    color: #AAAAAA;
}
.html_webtemplate {
    color: #0000AA;
}
.html_erb {
    color: #339933;
}
.html_tag {
    color: #AA5500;
}
.html_tag_block {
    color: #AA0000;
}
.html_comment {
    color: #00AA00;
}

div.day span.sanchor {
    display: none;
}

div.note {
    font-size: small;
    margin-bottom: 0.5em;
    text-align: right;
}

div.social{
    padding-bottom: 10px;
}

    --></style>
  <link rel="alternate" type="application/rss+xml" title="RSS" href="http://devtesting.jp/pekema/?c=rss">
</head>

<body>
<div class="whole-contents">
  <div class="contents">
    

<a name="top"> </a>
<div class="main">
  <div class="adminmenu"><span class="adminmenu"><a href="./">ぺけま</a></span>&nbsp;
<span class="adminmenu"><a href="./?c=index">Index</a></span>&nbsp;
<span class="adminmenu"><a href="./?c=search">Search</a></span>&nbsp;
<span class="adminmenu"><a href="./?c=recent">Changes</a></span>&nbsp;
<span class="adminmenu"><a href="./?c=rss">RSS</a></span>&nbsp;
<span class="adminmenu"><a href="./?c=login;p=0002%2FMockito">Login</a></span></div>
  <h1 class="header">MockitoでサクサクTest Double生活(下)</h1>
  
  <div><div class="day">
  
  <div class="body">
    <div class="section">
      <dl>
<dt>書いた人</dt>
<dd>大中浩行(せとあずさ♂)(<a href="https://twitter.com/setoazusa" class="external">@setoazusa</a>)
</dd>
</dl>
    </div>
  </div>
</div>
<div class="day">
  <h2><span class="date"><a name="l0"> </a></span><span class="title"><a href="./?0002%2FMockito">MockitoでサクサクTest Double生活(下)</a></span></h2>
  <div class="body">
    <div class="section">
      <p>前回に引き続き、Mockitoの紹介を行います。今回はMockitoの特徴のSpy機能と、7月にRC1がリリースされたMockito1.9.0の新機能の紹介です。</p>
<h3><a name="l1"><span class="sanchor"> </span></a>前号の訂正</h3>
<p><a href="./?0001%2FMockito">前回の記事</a>で、</p>
<blockquote><p>メソッドの呼び出し回数を検証する場合は、timesメソッドを使用します。</p>
</blockquote>
<p>と書きましたが、引数を1つ取る<a href="http://docs.mockito.googlecode.com/hg/latest/org/mockito/Mockito.html#verify(T)" class="external">verify</a>メソッドは第2引数に<a href="http://docs.mockito.googlecode.com/hg/latest/org/mockito/Mockito.html#times(int)" class="external">times</a>(1)を指定する検証のエイリアスですので、「メソッドが1回呼ばれた」ことを検証する場合はtimes(1)を指定する必要はありません。</p>
<p>なので、前回で例示した</p>
<pre>verify(response, times(1)).sendRedirect("/top.jsp");</pre>
<p>は、</p>
<pre>verify(response).sendRedirect("/top.jsp");</pre>
<p>で用を足します。</p>
<h3><a name="l2"><span class="sanchor"> </span></a>Spy</h3>
<p>Mockitoの特徴の一つとして、実オブジェクトに部分的にスタブの適用を行う、Spy機能があります。</p>
<p>Spyを作成するときは<a href="http://docs.mockito.googlecode.com/hg/latest/org/mockito/Mockito.html#spy(T)" class="external">spy</a>メソッドを使用します。Mockと同じく、finalクラスのモックを作成することはできません。</p>
<p>モックオブジェクトにスタブを適用する際は、</p>
<pre>when(list.add("value")).thenReturn(true);</pre>
<p>のような形式を使用しますが、Spyの場合はこの方法で記述すると、実オブジェクトのメソッドが呼ばれるため、オブジェクトの状態によっては例外が発生します。</p>
<pre>List&lt;String&gt; list = new ArrayList&lt;String&gt;();
list = spy(list);
//IndxOutOfBoundsExceptionになる
when(list.get(0)).thenReturn("value");</pre>
<p>これを避けるには、<a href="http://docs.mockito.googlecode.com/hg/latest/org/mockito/stubbing/Stubber.html#doReturn(java.lang.Object)" class="external">doReturn</a>メソッドや<a href="http://docs.mockito.googlecode.com/hg/latest/org/mockito/stubbing/Stubber.html#doThrow(java.lang.Throwable)" class="external">doThrow</a>メソッドを使用します。</p>
<pre>List&lt;String&gt; list = new ArrayList&lt;String&gt;();
list = spy(list);
// これは大丈夫
doReturn("value").when(list).get(0);
assertThat(list.get(0), is("value"));</pre>
<p>この点だけ注意すれば、モックと同じような感覚でSpyを使用することが出来るでしょう。</p>
<h3><a name="l3"><span class="sanchor"> </span></a>Mockito1.9の新機能</h3>
<h4><a name="l4"> </a>アノテーションによるSpy生成</h4>
<p>Mockitoにはテストケースのインスタンス変数に<a href="http://docs.mockito.googlecode.com/hg/latest/org/mockito/Mock.html" class="external">@Mock</a>アノテーションをつけることにより、モックの生成を行う機能があります。</p>
<p>Mockitoの1.9.0より、<a href="http://docs.mockito.googlecode.com/hg/latest/org/mockito/Spy.html" class="external">@Spy</a>アノテーションが導入され、インスタンス変数に<a href="http://docs.mockito.googlecode.com/hg/latest/org/mockito/Spy.html" class="external">@Spy</a>アノテーションをつけることにより、Spyの生成が出来るようになりました。</p>
<pre>//MockitoJUnitRunnerを指定する
@RunWith(MockitoJUnitRunner.class)
public class NewFeatureTest {
       /**
        * Spyを生成する
        */
       @Spy
       List&lt;String&gt; list = new ArrayList&lt;String&gt;();
       /**
        * Mockを生成する
        */
       @Mock
       List&lt;String&gt; mockList</pre>
<h4><a name="l5"> </a>ワンライナースタブ</h4>
<p>モックオブジェクトの生成とスタブの適用がワンライナーで出来るようになりました。</p>
<p>whenメソッドの引数内でmockメソッドを適用したモックを渡した後、スタブの適用を行い、最後に<a href="http://docs.mockito.googlecode.com/hg/latest/org/mockito/stubbing/OngoingStubbing.html#getMock()" class="external">getMock</a>メソッドで生成したモックを返します。</p>
<pre>@Test
public void ワンライナーによるモック生成() throws Exception {
    HttpServletRequest request = when(mock(HttpServletRequest.class).getParameter("param")).thenReturn("value").getMock();
    assertThat(request.getParameter("param"), is("value"));
}</pre>
<h4><a name="l6"> </a>検証時のスタブメソッド除外</h4>
<p>1つのモックオブジェクトにスタブの適用と検証を行った場合、スタブを適用したメソッドの呼び出しもモックオブジェクトとの間のインタラクションに含まれてしまうため、<a href="http://docs.mockito.googlecode.com/hg/latest/org/mockito/Mockito.html#verifyNoMoreInteractions(java.lang.Object...)" class="external">verifyNoMoreInteractions</a>メソッドなどを使用した場合に例外となっていました。</p>
<p>Mockitoの1.9.0より、<a href="http://docs.mockito.googlecode.com/hg/latest/org/mockito/Mockito.html#ignoreStubs(java.lang.Object...)" class="external">ignoreStubs</a>メソッドを使うことによって、スタブメソッドの呼び出しは検証の対象から除外することが出来るようになりました。</p>
<pre>	@Test
	public void ignoreStubによる検証の除外() throws Exception {
		List&lt;Integer&gt; mock1 = mock(List.class);

		//スタブの適用
		when(mock1.get(0)).thenReturn(10);

		//スタブメソッドの呼び出しもインタラクションに含まれる
		mock1.get(0);

		mock1.clear();

		verify(mock1).clear();

		try{
			verifyNoMoreInteractions(mock1);
			fail();
		} catch(NoInteractionsWanted ignore){
			//検証時に例外になっていた
		}
		//こちらは例外にならない
		verifyNoMoreInteractions(ignoreStubs(mock1));

	}</pre>
<p>ですが、著者の見解としては、この機能が必要になるということは、SUT(System Under Test) とモックの間で間接的入力と間接的出力の両方が必要になっているということであり、まずインターフェースの再検討を考えたほうがよいのではないか、と考えています。(コードベースが既存の場合はこの限りではありません)</p>
<h4><a name="l7"> </a>さいごに</h4>
<p>駆け足ですがMockitoについて紹介してきました。MockitoのAPIはここまで見て分かるとおり、非常にわかりやすく出来ていますので、テストのリズムを妨げることなく、モックの生成ができると思います。皆さんもぜひお試しください。</p>
    </div>
  </div>
</div>
</div>
  <div class="day">
    <div class="comment">
      <div class="caption">
        Last modified:2011/11/30 22:35:20<br>
        Keyword(s):<br>
        References:[<a href="./?0002">xUTP Magazine 0002号</a>] [<a href="./">ぺけま</a>] <br>
        
      </div>
    </div>
    <div><div class="footnote">
  <p class="footnote"><a name="f01" href="./?0002%2FMockito#fm01">*1</a>&nbsp;テストケースがテスト対象とするコンポーネント
</p>
</div>
</div>
  </div>
</div>

<hr style="display: none">
<div class="sidebar">
  <h3><a name="s0"><span class="sanchor"> </span></a>トップ</h3>
<h3><a name="s1"><span class="sanchor"> </span></a><a href="./?0004">0004号(2012/06/8)</a></h3>
<ul>
<li><a href="./?0004%2F%E5%B7%BB%E9%A0%AD%E8%A8%80">巻頭言</a></li>
<li><a href="./?0004%2FTopics">xUTP Topics: 第三回 xUnit Test Patterns の世界観「テストコードの不吉な臭い」</a></li>
<li><a href="./?0004%2FTddlive_Jo">TDD Live 番外編(TDD序破Q)</a></li>
<li><a href="./?0004%2F%E7%B7%A8%E9%9B%86%E5%BE%8C%E8%A8%98">編集後記</a></li>
</ul>
<h3><a name="s2"><span class="sanchor"> </span></a>バックナンバー</h3>
<ul>
<li><a href="./?0003">0003号(2011/12/31)</a></li>
<li><a href="./?0002">0002号(2011/11/30)</a></li>
<li><a href="./?0001">0001号(2011/11/05)</a></li>
</ul>
<h3><a name="s3"><span class="sanchor"> </span></a>リンク</h3>
<ul>
<li><a href="http://devtesting.jp/goos/" class="external">goos読書会Wiki</a></li>
<li><a href="http://www.fieldnotes.jp/xutp/" class="external">xUTP読書会Wiki</a></li>
<li><a href="http://devtesting.jp/tddbc" class="external">TDDBC Wiki</a></li>
<li><a href="http://groups.google.co.jp/group/devtesting-ja" class="external">devtesting-ja(Google Groups)</a></li>
<li><a href="http://xunitpatterns.com/" class="external">xUnitPatterns.com</a></li>
<li><a href="http://www.amazon.co.jp/dp/0131495054" class="external">xUnit Test Patterns(amazon.co.jp)</a></li>
</ul>
<h3><a name="s4"><span class="sanchor"> </span></a><a href="http://devtesting.jp/pekema/?c=rss" class="external">RSS</a></h3>

</div>


  </div>
  <div class="footer">Generated by <a href="http://hikiwiki.org/">Hiki</a> 1.0.0 (2013-03-30).<br>
Powered by <a href="http://www.ruby-lang.org/">Ruby</a> 2.1.6-p336 (2015-04-13).<br>
Founded by devtesing-ja.<br>
</div>
</div>
</body>
</html>
